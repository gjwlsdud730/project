<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>detail</title>
  <!-- jquery cdn -->
  <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
  <!-- bootstrap css -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <!-- bootstrap icon-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>

<div th:replace="~{/layout/layoutDetail :: body}">

  <div th:fragment="content" class="container my-1" style="border: 1px solid #dee2e6; padding: 15px; border-radius: 5px;">
    <div class="row">
      <div class="col-11">
        <div class="box">
          <h3 th:text="${board.boardTitle}"></h3>
          <br>
          <p>작성자: <span th:text="${board.userName}"></span></p>
          <p>작성일자: <span th:text="${#temporals.format(board.boardCreatedTime, 'yyyy-MM-dd HH.mm')}"></span></p>
          <p>조회수: <span th:text="${board.boardHits}"></span></p>
        </div>
        <hr>
        <div class="box" style="min-height: 5em;">
          <p th:utext="${board.boardContents}"></p>
          <!--          session 값 확인: <p th:text="${session.userIndex}"></p>-->
          <div th:if="${board.fileAttached == 1}">
            <p th:each="fileName: ${board.storedFileName}">
              <img th:src="@{|/upload/${fileName}|}" alt="">
            </p>
          </div>
        </div>
        <hr>
        <div th:if="${session.userIndex == board.userIndex}">
          <button onclick="updateReq()">수정</button>
          <button onclick="deleteReq()">삭제</button>
          <hr>
        </div>
        <div>

          <div id="comment-write" class="d-flex flex-column mb-3">
            <input type="hidden" id="boardId" th:value="${board.id}">
            <input type="hidden" id="commentWriter" th:value="${loggedInUser}">

            <!-- 댓글 내용 입력 -->
            <textarea id="commentContents" class="form-control mb-2" placeholder="댓글을 입력하세요." style="height: 3em;"></textarea>

            <!-- 댓글 작성 버튼 -->
            <div class="d-flex justify-content-end">
              <button id="comment-write-btn" class="btn btn-dark" onclick="commentWrite()">댓글작성</button>
            </div>
          </div>

          <div id="comment-list" class="border rounded">
            <table class="table">
              <tbody>
              <tr th:each="comment: ${commentList}">
                <!-- 댓글 작성자 (볼드체) 및 작성 시간 (작게) -->
                <td>
                  <span class="font-weight-bold" th:text="${comment.commentWriter}"></span>
                  <div class="text-muted small" th:text="${#temporals.format(comment.commentCreatedTime, 'yyyy-MM-dd HH.mm')}"> </div>
                  <!-- 댓글 내용 (패딩 추가) -->
                  <div class="pt-2" th:text="${comment.commentContents}"></div>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
<script th:inline="javascript">
    const commentWrite = () => {
        const writer = document.getElementById("commentWriter").value;
        const contents = document.getElementById("commentContents").value;
        // 숨겨진 입력 필드에서 게시글 ID 읽기
        const boardId = document.getElementById("boardId").value;

        console.log("작성자: ", writer);
        console.log("내용: ", contents);
        console.log("게시글 ID: ", boardId); // 콘솔에 게시글 ID 출력

        $.ajax({
            "type": "post",
            "url": "/comment/save",
            data: {
                "commentWriter": writer,
                "commentContents": contents,
                "boardId": boardId // 수정된 부분: 게시글 ID 전송
            },
            success: function (res) {
                console.log("요청성공", res);
                let output = '<div class="border rounded"><table class="table"><tbody>';
                for (let i in res) {
                    output += '<tr>';
                    output += '<td>';
                    output += '<span class="font-weight-bold">' + res[i].commentWriter + '</span>';
                    output += '<div class="text-muted small">' + res[i].commentCreatedTime + '</div>';
                    output += '<div class="pt-2">' + res[i].commentContents + '</div>';
                    output += '</td>';
                    output += '</tr>';
                }
                output += '</tbody></table></div>';
                document.getElementById('comment-list').innerHTML = output;
                document.getElementById('commentWriter').value = '';
                document.getElementById('commentContents').value = '';
            },
            error: function (err) {
                console.log("요청실패", err);
            }
        });
    }

    const updateReq = () => {
        console.log("수정 요청");
        const id = [[${board.id}]];
        location.href = "/board/update/" + id;
    }
    const deleteReq = () => {
        console.log("삭제 요청");
        const id = [[${board.id}]];
        location.href = "/board/delete/" + id;
    }
</script>
<script src="https://code.jquery.com/jquery-3.4.1.js" ></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</html>